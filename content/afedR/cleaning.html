<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 9 Cleaning and Structuring Data | Analyzing Financial and Economic Data with R - Online Edition</title>
<meta name="author" content="Marcelo S. Perlin (marcelo.perlin@ufrgs.br)">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.2"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.5.1/jquery-3.5.1.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.5.3/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.5.3/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.2.4/tabs.js"></script><script src="libs/bs3compat-0.2.4/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script><script>
  
      /* update total correct if #total_correct exists */
      update_total_correct = function() {
        if (t = document.getElementById("total_correct")) {
          t.innerHTML =
            document.getElementsByClassName("correct").length + " of " +
            document.getElementsByClassName("solveme").length + " correct";
        }
      }
      
      /* solution button toggling function */
      b_func = function() {
        var cl = this.parentElement.classList;
        if (cl.contains('open')) {
          cl.remove("open");
        } else {
          cl.add("open");
        }
      }
      
      /* function for checking solveme answers */
      solveme_func = function(e) {
        var real_answers = JSON.parse(this.dataset.answer);
        var my_answer = this.value;
        var cl = this.classList;
        if (cl.contains("ignorecase")) {
          my_answer = my_answer.toLowerCase();
        }
        if (cl.contains("nospaces")) {
          my_answer = my_answer.replace(/ /g, "");
        }
        
        if (my_answer !== "" & real_answers.includes(my_answer)) {
          cl.add("correct");
        } else {
          cl.remove("correct");
        }
      
        // match numeric answers within a specified tolerance
        if(this.dataset.tol > 0){
          var tol = JSON.parse(this.dataset.tol);  
          var matches = real_answers.map(x => Math.abs(x - my_answer) < tol)
          if (matches.reduce((a, b) => a + b, 0) > 0) {
            cl.add("correct");
          } else {
            cl.remove("correct");
          }  
        }
      
        // added regex bit
        if (cl.contains("regex")){
          answer_regex = RegExp(real_answers.join("|"))
          if (answer_regex.test(my_answer)) {
            cl.add("correct");
          }  
        }
        
        update_total_correct();
      }
      
      window.onload = function() {
        /* set up solution buttons */
        var buttons = document.getElementsByTagName("button");
      
        for (var i = 0; i < buttons.length; i++) {
          if (buttons[i].parentElement.classList.contains('solution')) {
            buttons[i].onclick = b_func;
          }
        }
        
        /* set up solveme inputs */
        var solveme = document.getElementsByClassName("solveme");
      
        for (var i = 0; i < solveme.length; i++) {
          /* make sure input boxes don't auto-anything */
          solveme[i].setAttribute("autocomplete","off");
          solveme[i].setAttribute("autocorrect", "off");
          solveme[i].setAttribute("autocapitalize", "off"); 
          solveme[i].setAttribute("spellcheck", "false");
          solveme[i].value = "";
          
          /* adjust answer for ignorecase or nospaces */
          var cl = solveme[i].classList;
          var real_answer = solveme[i].dataset.answer;
          if (cl.contains("ignorecase")) {
            real_answer = real_answer.toLowerCase();
          }
          if (cl.contains("nospaces")) {
            real_answer = real_answer.replace(/ /g, "");
          }
          solveme[i].dataset.answer = real_answer;
          
          /* attach checking function */
          solveme[i].onkeyup = solveme_func;
          solveme[i].onchange = solveme_func;
        }
        
        update_total_correct();
      }
      
      </script><script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js"></script><!-- CSS --><link rel="stylesheet" href="css/style_html.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Analyzing Financial and Economic Data with R - Online Edition</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome!</a></li>
<li><a class="" href="about-new-edition.html">About New Edition</a></li>
<li><a class="" href="preface.html">Preface</a></li>
<li><a class="" href="introduction.html"><span class="header-section-number">1</span> Introduction</a></li>
<li><a class="" href="basicoperations.html"><span class="header-section-number">2</span> Basic Operations in R</a></li>
<li><a class="" href="research-scripts.html"><span class="header-section-number">3</span> Writing Research Scripts</a></li>
<li><a class="" href="importing.html"><span class="header-section-number">4</span> Importing Data from Local Files</a></li>
<li><a class="" href="importing-internet.html"><span class="header-section-number">5</span> Importing Data from the Internet</a></li>
<li><a class="" href="data-structure-objects.html"><span class="header-section-number">6</span> Dataframes and other objects</a></li>
<li><a class="" href="basic-classes.html"><span class="header-section-number">7</span> Basic Object Classes</a></li>
<li><a class="" href="programming.html"><span class="header-section-number">8</span> Programming and Data Analysis</a></li>
<li><a class="active" href="cleaning.html"><span class="header-section-number">9</span> Cleaning and Structuring Data</a></li>
<li><a class="" href="figures.html"><span class="header-section-number">10</span> Creating and Saving Figures with ggplot2</a></li>
<li><a class="" href="models.html"><span class="header-section-number">11</span> Financial Econometrics with R</a></li>
<li><a class="" href="reporting.html"><span class="header-section-number">12</span> Reporting Results</a></li>
<li><a class="" href="optimizing.html"><span class="header-section-number">13</span> Optimizing Code</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-98297869-1', 'auto');
  ga('send', 'pageview');

</script><!-- Global site tag (gtag.js) - Google Analytics GOOGLE ADS--><script async src="https://www.googletagmanager.com/gtag/js?id=UA-89690212-2">
</script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-89690212-2');
</script><div id="cleaning" class="section level1">
<h1>
<span class="header-section-number">9</span> Cleaning and Structuring Data<a class="anchor" aria-label="anchor" href="#cleaning"><i class="fas fa-link"></i></a>
</h1>
<div class="pleasebuyit">
<p>
You reached the end of the online version of <em>Analyzing Financial and Economic Data with R</em>. The full content of the book can be acquired at <a href="https://www.amazon.com/dp/B084LSNXMN">Amazon</a> for less than ten dollars. Purchasing this book is a great way of supporting this and other projects of the <a href="https://www.msperlin.com/blog/">author</a>. If you are satisfied with the content, please leave your feedback at Amazon or by email (<a href="mailto:marceloperlin@gmail.com" class="email">marceloperlin@gmail.com</a>). The book is a lifelong project and I’ll keep improving it based on the received feedback.
</p>
</div>
<div id="the-format-of-a-dataframe" class="section level2">
<h2>
<span class="header-section-number">9.1</span> The Format of a <code>dataframe</code><a class="anchor" aria-label="anchor" href="#the-format-of-a-dataframe"><i class="fas fa-link"></i></a>
</h2>
<div class="pleasebuyit">
<p>
You reached the end of the online version of <em>Analyzing Financial and Economic Data with R</em>. The full content of the book can be acquired at <a href="https://www.amazon.com/dp/B084LSNXMN">Amazon</a> for less than ten dollars. Purchasing this book is a great way of supporting this and other projects of the <a href="https://www.msperlin.com/blog/">author</a>. If you are satisfied with the content, please leave your feedback at Amazon or by email (<a href="mailto:marceloperlin@gmail.com" class="email">marceloperlin@gmail.com</a>). The book is a lifelong project and I’ll keep improving it based on the received feedback.
</p>
</div>
<div id="converting-a-dataframe-structure-long-and-wide" class="section level3">
<h3>
<span class="header-section-number">9.1.1</span> Converting a <code>dataframe</code> Structure (long and wide)<a class="anchor" aria-label="anchor" href="#converting-a-dataframe-structure-long-and-wide"><i class="fas fa-link"></i></a>
</h3>
<div class="pleasebuyit">
<p>
You reached the end of the online version of <em>Analyzing Financial and Economic Data with R</em>. The full content of the book can be acquired at <a href="https://www.amazon.com/dp/B084LSNXMN">Amazon</a> for less than ten dollars. Purchasing this book is a great way of supporting this and other projects of the <a href="https://www.msperlin.com/blog/">author</a>. If you are satisfied with the content, please leave your feedback at Amazon or by email (<a href="mailto:marceloperlin@gmail.com" class="email">marceloperlin@gmail.com</a>). The book is a lifelong project and I’ll keep improving it based on the received feedback.
</p>
</div>
</div>
</div>
<div id="converting-lists-into-dataframes" class="section level2">
<h2>
<span class="header-section-number">9.2</span> Converting <code>lists</code> into <code>dataframes</code><a class="anchor" aria-label="anchor" href="#converting-lists-into-dataframes"><i class="fas fa-link"></i></a>
</h2>
<div class="pleasebuyit">
<p>
You reached the end of the online version of <em>Analyzing Financial and Economic Data with R</em>. The full content of the book can be acquired at <a href="https://www.amazon.com/dp/B084LSNXMN">Amazon</a> for less than ten dollars. Purchasing this book is a great way of supporting this and other projects of the <a href="https://www.msperlin.com/blog/">author</a>. If you are satisfied with the content, please leave your feedback at Amazon or by email (<a href="mailto:marceloperlin@gmail.com" class="email">marceloperlin@gmail.com</a>). The book is a lifelong project and I’ll keep improving it based on the received feedback.
</p>
</div>
</div>
<div id="removing-outliers" class="section level2">
<h2>
<span class="header-section-number">9.3</span> Removing Outliers<a class="anchor" aria-label="anchor" href="#removing-outliers"><i class="fas fa-link"></i></a>
</h2>
<div class="pleasebuyit">
<p>
You reached the end of the online version of <em>Analyzing Financial and Economic Data with R</em>. The full content of the book can be acquired at <a href="https://www.amazon.com/dp/B084LSNXMN">Amazon</a> for less than ten dollars. Purchasing this book is a great way of supporting this and other projects of the <a href="https://www.msperlin.com/blog/">author</a>. If you are satisfied with the content, please leave your feedback at Amazon or by email (<a href="mailto:marceloperlin@gmail.com" class="email">marceloperlin@gmail.com</a>). The book is a lifelong project and I’ll keep improving it based on the received feedback.
</p>
</div>
<div id="outliers" class="section level3">
<h3>
<span class="header-section-number">9.3.1</span> Treating Outliers in <code>dataframes</code><a class="anchor" aria-label="anchor" href="#outliers"><i class="fas fa-link"></i></a>
</h3>
<div class="pleasebuyit">
<p>
You reached the end of the online version of <em>Analyzing Financial and Economic Data with R</em>. The full content of the book can be acquired at <a href="https://www.amazon.com/dp/B084LSNXMN">Amazon</a> for less than ten dollars. Purchasing this book is a great way of supporting this and other projects of the <a href="https://www.msperlin.com/blog/">author</a>. If you are satisfied with the content, please leave your feedback at Amazon or by email (<a href="mailto:marceloperlin@gmail.com" class="email">marceloperlin@gmail.com</a>). The book is a lifelong project and I’ll keep improving it based on the received feedback.
</p>
</div>
</div>
</div>
<div id="inflation-and-price-data" class="section level2">
<h2>
<span class="header-section-number">9.4</span> Inflation and Price Data<a class="anchor" aria-label="anchor" href="#inflation-and-price-data"><i class="fas fa-link"></i></a>
</h2>
<div class="pleasebuyit">
<p>
You reached the end of the online version of <em>Analyzing Financial and Economic Data with R</em>. The full content of the book can be acquired at <a href="https://www.amazon.com/dp/B084LSNXMN">Amazon</a> for less than ten dollars. Purchasing this book is a great way of supporting this and other projects of the <a href="https://www.msperlin.com/blog/">author</a>. If you are satisfied with the content, please leave your feedback at Amazon or by email (<a href="mailto:marceloperlin@gmail.com" class="email">marceloperlin@gmail.com</a>). The book is a lifelong project and I’ll keep improving it based on the received feedback.
</p>
</div>
</div>
<div id="modifying-time-frequency-and-aggregating-data" class="section level2">
<h2>
<span class="header-section-number">9.5</span> Modifying Time Frequency and Aggregating Data<a class="anchor" aria-label="anchor" href="#modifying-time-frequency-and-aggregating-data"><i class="fas fa-link"></i></a>
</h2>
<div class="pleasebuyit">
<p>
You reached the end of the online version of <em>Analyzing Financial and Economic Data with R</em>. The full content of the book can be acquired at <a href="https://www.amazon.com/dp/B084LSNXMN">Amazon</a> for less than ten dollars. Purchasing this book is a great way of supporting this and other projects of the <a href="https://www.msperlin.com/blog/">author</a>. If you are satisfied with the content, please leave your feedback at Amazon or by email (<a href="mailto:marceloperlin@gmail.com" class="email">marceloperlin@gmail.com</a>). The book is a lifelong project and I’ll keep improving it based on the received feedback.
</p>
</div>
</div>
<div id="exercises-7" class="section level2">
<h2>
<span class="header-section-number">9.6</span> Exercises<a class="anchor" aria-label="anchor" href="#exercises-7"><i class="fas fa-link"></i></a>
</h2>
<div class="pleasebuyit">
<p>
You reached the end of the online version of <em>Analyzing Financial and Economic Data with R</em>. The full content of the book can be acquired at <a href="https://www.amazon.com/dp/B084LSNXMN">Amazon</a> for less than ten dollars. Purchasing this book is a great way of supporting this and other projects of the <a href="https://www.msperlin.com/blog/">author</a>. If you are satisfied with the content, please leave your feedback at Amazon or by email (<a href="mailto:marceloperlin@gmail.com" class="email">marceloperlin@gmail.com</a>). The book is a lifelong project and I’ll keep improving it based on the received feedback.
</p>
</div>
</div>
<div id="exercises-8" class="section level2">
<h2>
<span class="header-section-number">9.7</span> Exercises<a class="anchor" aria-label="anchor" href="#exercises-8"><i class="fas fa-link"></i></a>
</h2>
<hr>
<p><span id="total_correct"></span></p>
<div id="q.1-8" class="section level3 unnumbered">
<h3>Q.1<a class="anchor" aria-label="anchor" href="#q.1-8"><i class="fas fa-link"></i></a>
</h3>
<p>Consider the <code>dataframe</code> created with the following code:</p>
<pre class="text"><code><a href="http://tidyverse.tidyverse.org">library(tidyverse)

my_N &lt;- 100

df &lt;- bind_rows(tibble(ticker = rep('STOCK 1', my_N),
                       ref_date = Sys.Date() + 1:my_N,
                       price = 100 + cumsum(rnorm(my_N))),
                tibble(ticker = rep('STOCK 2', my_N),
                       ref_date = Sys.Date() + 1:my_N,
                       price = 100 + cumsum(rnorm(my_N))) )

print(df)</a></code></pre>
<p>Is the <code>dataframe</code> format long or wide? Explain your answer.</p>
<div style="text-align: left; margin-top: 2px; padding: 13px 0 10px 0;">
<p>
<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#collapse_3aa021c99fd0" aria-expanded="false" aria-controls="collapseExample">
Solution
</button>
</p>
</div>
<div id="collapse_3aa021c99fd0" class="collapse">
<div class="card card-body">
<p>The format is long: we have data stacked for two different stocks. Note that, with the addition of new tickers, the table grows with new lines. New variables can be easily added with new columns.</p>
</div>
</div>
<hr>
<p><span id="total_correct"></span></p>
</div>
<div id="q.2-8" class="section level3 unnumbered">
<h3>Q.2<a class="anchor" aria-label="anchor" href="#q.2-8"><i class="fas fa-link"></i></a>
</h3>
<p>Change the format of the previous <code>dataframe</code>, from long to wide or vice versa.</p>
<pre class="text"><code><a href="http://tidyverse.tidyverse.org">library(tidyverse)

my_N &lt;- 100

df &lt;- bind_rows(tibble(ticker = rep('STOCK 1', my_N),
                       ref_date = Sys.Date() + 1:my_N,
                       price = 100 + cumsum(rnorm(my_N))),
                tibble(ticker = rep('STOCK 2', my_N),
                       ref_date = Sys.Date() + 1:my_N,
                       price = 100 + cumsum(rnorm(my_N))) )

print(df)</a></code></pre>
<div style="text-align: left; margin-top: 2px; padding: 13px 0 10px 0;">
<p>
<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#collapse_3aa025526b7d" aria-expanded="false" aria-controls="collapseExample">
Solution
</button>
</p>
</div>
<div id="collapse_3aa025526b7d" class="collapse">
In order to execute the code, open a new R script in RStudio (Control+shift+N), copy and paste the code, and execute it whole by pressing Control+Shift+Enter or line by line with shortcut Control+Enter.
<div class="card card-body">
<pre class="text"><code><a href="http://tidyverse.tidyverse.org">library(tidyverse)

my_N &lt;- 100

df &lt;- bind_rows(tibble(ticker = rep('STOCK 1', my_N),
                       ref_date = Sys.Date() + 1:my_N,
                       price = 100 + cumsum(rnorm(my_N))),
                tibble(ticker = rep('STOCK 2', my_N),
                       ref_date = Sys.Date() + 1:my_N,
                       price = 100 + cumsum(rnorm(my_N))) )

print(df)

# convert from long to wide
df_wide &lt;- spread(data = df, 
                  key = 'ticker',
                  value = 'price')

# print result
print(df_wide)</a></code></pre>
</div>
</div>
<hr>
<p><span id="total_correct"></span></p>
</div>
<div id="q.3-7" class="section level3 unnumbered">
<h3>Q.3<a class="anchor" aria-label="anchor" href="#q.3-7"><i class="fas fa-link"></i></a>
</h3>
<p>Consider the following list:</p>
<pre class="text"><code><a href="http://tidyverse.tidyverse.org">library(tidyverse)

my_l &lt;- list(df1 = tibble(x = 1:100, y = runif(100)),
             df2 = tibble(x = 1:100, y = runif(100), v = runif(100)),
             df3 = tibble(x = 1:100, y = runif(100), z = runif(100)) )</a></code></pre>
<p>Add all <code>dataframes</code> in <code>my_l</code> to a single object using <code>do.call</code> or <code><a href="https://dplyr.tidyverse.org/reference/bind.html">dplyr::bind_rows</a></code> functions. What happened to the <code>df1</code> data where <code>v</code> and <code>z</code> columns do not exist?</p>
<div style="text-align: left; margin-top: 2px; padding: 13px 0 10px 0;">
<p>
<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#collapse_3aa032b4e504" aria-expanded="false" aria-controls="collapseExample">
Solution
</button>
</p>
</div>
<div id="collapse_3aa032b4e504" class="collapse">
In order to execute the code, open a new R script in RStudio (Control+shift+N), copy and paste the code, and execute it whole by pressing Control+Shift+Enter or line by line with shortcut Control+Enter.
<div class="card card-body">
<p>When <code>bind_rows</code> does not find the same column at the junction of different tables, the missing data is defined as <code>NAs</code>. See below:</p>
<pre class="text"><code><a href="http://tidyverse.tidyverse.org">library(tidyverse)

my_l &lt;- list(df1 = tibble(x = 1:100, 
                          y = runif(100)),
             df2 = tibble(x = 1:100, 
                          y = runif(100), 
                          v = runif(100)),
             df3 = tibble(x = 1:100, 
                          y = runif(100), 
                          z = runif(100)) )

# solution with bind_rows
bind_df1 &lt;- bind_rows(my_l)

# solution with do.cal
bind_df2 &lt;- do.call(bind_rows, my_l)

# check solutions match
identical(bind_df1, bind_df2)

print(bind_df1)
# the missing data points were set as NA values</a></code></pre>
</div>
</div>
<hr>
<p><span id="total_correct"></span></p>
</div>
<div id="q.4-7" class="section level3 unnumbered">
<h3>Q.4<a class="anchor" aria-label="anchor" href="#q.4-7"><i class="fas fa-link"></i></a>
</h3>
<p>Use the <code>BatchGetSymbols</code> package to download the SP500 index data (<code>'^GSPC'</code>) from 1950-01-01 to 2021-01-01. What is the sum of the 5 highest positive returns on the index?</p>
<br> Your Answer: <select class="solveme" data-answer='["0.50138"]'><option></option>
<option>0.50138</option>
<option>0.38701</option>
<option>0.16674</option>
<option>0.05661</option>
<option>0.27688</option></select><div style="text-align: left; margin-top: 2px; padding: 13px 0 10px 0;">
<p>
<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#collapse_3aa0e63bee3" aria-expanded="false" aria-controls="collapseExample">
Solution
</button>
</p>
</div>
<div id="collapse_3aa0e63bee3" class="collapse">
The solution is 0.50138. To reach the same result, you must execute the code below. For that, open a new R script in RStudio (Control+shift+N), copy and paste the code, and execute it whole by pressing Control+Shift+Enter or line by line with shortcut Control+Enter.
<div class="card card-body">
<pre class="text"><code><a href="https://rdrr.io/r/base/library.html">library(BatchGetSymbols)

ticker &lt;- '^GSPC'
first_date &lt;- '1950-01-01'
last_date &lt;- '2021-01-01'
df_SP500 &lt;- BatchGetSymbols(tickers = '^GSPC', 
                            first.date = first_date,
                            last.date = last_date)[[2]]

select_n &lt;- 5
tab &lt;- dplyr::tibble(position = 1:select_n,
              top5_positive = sort(df_SP500$ret.adjusted.prices, 
                                   decreasing = TRUE)[1:select_n],
              top5_negative = sort(df_SP500$ret.adjusted.prices, 
                                   decreasing = FALSE)[1:select_n])

print(tab)

my_sol &lt;- sum(tab$top5_positive)</a></code></pre>
</div>
</div>
<hr>
<p><span id="total_correct"></span></p>
</div>
<div id="q.5-7" class="section level3 unnumbered">
<h3>Q.5<a class="anchor" aria-label="anchor" href="#q.5-7"><i class="fas fa-link"></i></a>
</h3>
<p>Use the <code>replace_outliers</code> function (see section <a href="cleaning.html#outliers">9.3.1</a>) to remove <em>outliers</em> from all numeric columns of the SP500 data previously imported with <code>my_prob = 0.025</code>. How many lines were <strong>lost</strong> in this cleaning process?</p>
<br> Your Answer: <select class="solveme" data-answer='["7282"]'><option></option>
<option>7282</option>
<option>18005</option>
<option>1843</option>
<option>10723</option>
<option>4729</option></select><div style="text-align: left; margin-top: 2px; padding: 13px 0 10px 0;">
<p>
<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#collapse_3aa0461fcb9" aria-expanded="false" aria-controls="collapseExample">
Solution
</button>
</p>
</div>
<div id="collapse_3aa0461fcb9" class="collapse">
The solution is 7282. To reach the same result, you must execute the code below. For that, open a new R script in RStudio (Control+shift+N), copy and paste the code, and execute it whole by pressing Control+Shift+Enter or line by line with shortcut Control+Enter.
<div class="card card-body">
<pre class="text"><code><a href="https://rdrr.io/r/base/library.html">library(BatchGetSymbols)
library(purrr)

ticker &lt;- '^GSPC'
first_date &lt;- '1950-01-01'
last_date &lt;- '2021-01-01'
df_SP500 &lt;- BatchGetSymbols(tickers = '^GSPC', 
                            first.date = first_date,
                            last.date = last_date)[[2]]

replace_outliers &lt;- function(col_in, my_prob = 0.05) {
  # Replaces outliers from a vector
  #
  # INPUTS: col_in The vector
  #         my_prob Probability of quantiles (p and 1-p)
  #
  # OUTPUT: A vector
  
  # return if class is other than numeric
  if (!(class(col_in) %in% c('numeric', 'integer'))) return(col_in)
  
  my_outliers &lt;- stats::quantile(x = col_in,
                                 probs = c(my_prob, 1-my_prob),
                                 na.rm = TRUE)
  
  idx &lt;- (col_in &lt;= my_outliers[1])|(col_in &gt;= my_outliers[2])
  col_in[idx] &lt;- NA
  
  return(col_in)
  
}

# remove outlivers from vectors
l_out &lt;- map(df_SP500, replace_outliers, my_prob = 0.025)

df_SP500_nooutlier &lt;- na.omit(as_tibble(l_out))

nrow_1 &lt;- nrow(df_SP500)
nrow_2 &lt;- nrow(df_SP500_nooutlier)

my_sol &lt;- nrow_1 - nrow_2</a></code></pre>
</div>
</div>
<hr>
<p><span id="total_correct"></span></p>
</div>
<div id="q.6-7" class="section level3 unnumbered">
<h3>Q.6<a class="anchor" aria-label="anchor" href="#q.6-7"><i class="fas fa-link"></i></a>
</h3>
<p>Use the <code><a href="https://rdrr.io/pkg/BatchGetSymbols/man/BatchGetSymbols.html">BatchGetSymbols::BatchGetSymbols</a></code> function to import the prices of the FTSE index (<code>'^ FTSE'</code>) from 2010-01-01 to 2021-01-01. Then, reconstruct the data at the annual frequency, defining each year’s value as the last observation of the period. Tip: see the <code>dplyr::summary_all</code> function for a functional way to aggregate all the columns of a <code>dataframe</code>.</p>
<div style="text-align: left; margin-top: 2px; padding: 13px 0 10px 0;">
<p>
<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#collapse_3aa014b585cb" aria-expanded="false" aria-controls="collapseExample">
Solution
</button>
</p>
</div>
<div id="collapse_3aa014b585cb" class="collapse">
In order to execute the code, open a new R script in RStudio (Control+shift+N), copy and paste the code, and execute it whole by pressing Control+Shift+Enter or line by line with shortcut Control+Enter.
<div class="card card-body">
<pre class="text"><code><a href="https://rdrr.io/r/base/library.html">library(BatchGetSymbols)

ticker &lt;- '^FTSE'

first_date &lt;- '2010-01-01'
last_date &lt;- '2021-01-01'

df_FTSE_daily &lt;- BatchGetSymbols(tickers = ticker, 
                            first.date = first_date,
                            last.date = last_date)[[2]]

# change from daily to annual
df_FTSE_yearly &lt;- df_FTSE_daily %&gt;%
  mutate(ref_year = lubridate::year(ref.date)) %&gt;%
  group_by(ref_year) %&gt;%
  summarise_all(.funs = last)

print(df_FTSE_yearly)</a></code></pre>
</div>
</div>
<hr>
<p><span id="total_correct"></span></p>
</div>
<div id="q.7-6" class="section level3 unnumbered">
<h3>Q.7<a class="anchor" aria-label="anchor" href="#q.7-6"><i class="fas fa-link"></i></a>
</h3>
<p>Use the same daily data as the FTSE and reconstruct the data at the monthly frequency, again using the last observation of the period.</p>
<div style="text-align: left; margin-top: 2px; padding: 13px 0 10px 0;">
<p>
<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#collapse_3aa085a8d11" aria-expanded="false" aria-controls="collapseExample">
Solution
</button>
</p>
</div>
<div id="collapse_3aa085a8d11" class="collapse">
In order to execute the code, open a new R script in RStudio (Control+shift+N), copy and paste the code, and execute it whole by pressing Control+Shift+Enter or line by line with shortcut Control+Enter.
<div class="card card-body">
<pre class="text"><code><a href="https://rdrr.io/r/base/library.html">library(BatchGetSymbols)

ticker &lt;- '^FTSE'

first_date &lt;- '2010-01-01'
last_date &lt;- '2021-01-01'

df_FTSE_daily &lt;- BatchGetSymbols(tickers = ticker, 
                            first.date = first_date,
                            last.date = last_date)[[2]]

# change from daily to monthly
df_FTSE_monthly &lt;- df_FTSE_daily %&gt;%
  mutate(ref_month = format(ref.date, '%Y-%m-01')) %&gt;%
  group_by(ref_month) %&gt;%
  summarise_all(last)

print(df_FTSE_monthly)</a></code></pre>
</div>
</div>
<hr>
<p><span id="total_correct"></span></p>
</div>
<div id="q.8-5" class="section level3 unnumbered">
<h3>Q.8<a class="anchor" aria-label="anchor" href="#q.8-5"><i class="fas fa-link"></i></a>
</h3>
<p>For the same daily FTSE data, check the dates and prices of the 20 biggest price drops. If, for each of these cases, an investor bought the index at the price of the biggest drops and kept it for 30 days, what would be his average nominal return per transaction?</p>
<br> Your Answer: <select class="solveme" data-answer='["2.53%"]'><option></option>
<option>0.32%</option>
<option>0.85%</option>
<option>1.38%</option>
<option>1.92%</option>
<option>2.53%</option></select><div style="text-align: left; margin-top: 2px; padding: 13px 0 10px 0;">
<p>
<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#collapse_3aa019863bc9" aria-expanded="false" aria-controls="collapseExample">
Solution
</button>
</p>
</div>
<div id="collapse_3aa019863bc9" class="collapse">
The solution is 2.53%. To reach the same result, you must execute the code below. For that, open a new R script in RStudio (Control+shift+N), copy and paste the code, and execute it whole by pressing Control+Shift+Enter or line by line with shortcut Control+Enter.
<div class="card card-body">
<pre class="text"><code><a href="http://tidyverse.tidyverse.org">library(tidyverse)
library(BatchGetSymbols)

ticker &lt;- '^FTSE'

first_date &lt;- '2010-01-01'
last_date &lt;- '2021-01-01'

df_FTSE_daily &lt;- BatchGetSymbols(tickers = ticker, 
                            first.date = first_date,
                            last.date = last_date)[[2]]

# buy at t, sell at t+30
trade_window &lt;- 30 

# find largest drops
largest_drops &lt;- df_FTSE_daily %&gt;%
  arrange(ret.adjusted.prices) %&gt;%
  slice(1:20)

# There are many ways to solve the exercise. 
# Here we will use a loop which is the simplest way to looking at the problem.
# You could also solve it with the functional approach of package purrrr,
# that is, writing a function.

tab &lt;- tibble()
for (i_date in seq_along(largest_drops$ref.date)) {
  
  my_date &lt;- largest_drops$ref.date[i_date]
  # filter data to keep only datapoints in each horizon
  temp_df &lt;- df_FTSE_daily %&gt;%
    filter(ref.date &gt;= my_date,
           ref.date &lt;= my_date + trade_window)
  
  
  buy_price &lt;- first(temp_df$price.adjusted)
  sell_price &lt;- last(temp_df$price.adjusted)
  return &lt;- sell_price/buy_price - 1
  
  tab &lt;- bind_rows(tab, 
                   tibble(date = my_date, 
                          buy_price = buy_price, 
                          sell_price = sell_price, 
                          return = return))
}

print(tab)

# solution
my_sol &lt;- mean(tab$return)</a></code></pre>
</div>
</div>

</div>
</div>
</div>
<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://afedr-ed2.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>
  <div class="chapter-nav">
<div class="prev"><a href="programming.html"><span class="header-section-number">8</span> Programming and Data Analysis</a></div>
<div class="next"><a href="figures.html"><span class="header-section-number">10</span> Creating and Saving Figures with ggplot2</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#cleaning"><span class="header-section-number">9</span> Cleaning and Structuring Data</a></li>
<li>
<a class="nav-link" href="#the-format-of-a-dataframe"><span class="header-section-number">9.1</span> The Format of a dataframe</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#converting-a-dataframe-structure-long-and-wide"><span class="header-section-number">9.1.1</span> Converting a dataframe Structure (long and wide)</a></li></ul>
</li>
<li><a class="nav-link" href="#converting-lists-into-dataframes"><span class="header-section-number">9.2</span> Converting lists into dataframes</a></li>
<li>
<a class="nav-link" href="#removing-outliers"><span class="header-section-number">9.3</span> Removing Outliers</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#outliers"><span class="header-section-number">9.3.1</span> Treating Outliers in dataframes</a></li></ul>
</li>
<li><a class="nav-link" href="#inflation-and-price-data"><span class="header-section-number">9.4</span> Inflation and Price Data</a></li>
<li><a class="nav-link" href="#modifying-time-frequency-and-aggregating-data"><span class="header-section-number">9.5</span> Modifying Time Frequency and Aggregating Data</a></li>
<li><a class="nav-link" href="#exercises-7"><span class="header-section-number">9.6</span> Exercises</a></li>
<li>
<a class="nav-link" href="#exercises-8"><span class="header-section-number">9.7</span> Exercises</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#q.1-8">Q.1</a></li>
<li><a class="nav-link" href="#q.2-8">Q.2</a></li>
<li><a class="nav-link" href="#q.3-7">Q.3</a></li>
<li><a class="nav-link" href="#q.4-7">Q.4</a></li>
<li><a class="nav-link" href="#q.5-7">Q.5</a></li>
<li><a class="nav-link" href="#q.6-7">Q.6</a></li>
<li><a class="nav-link" href="#q.7-6">Q.7</a></li>
<li><a class="nav-link" href="#q.8-5">Q.8</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Analyzing Financial and Economic Data with R - Online Edition</strong>" was written by Marcelo S. Perlin (<a href="mailto:marcelo.perlin@ufrgs.br" class="email">marcelo.perlin@ufrgs.br</a>). It was last built on 2021-03-30.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>
</html>
